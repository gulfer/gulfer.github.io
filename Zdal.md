# 分布式事务

最近在做代码评审的时候遇到这么一个问题：在某个声明式事务中使用了两个不同的数据源，而配置的事务管理器仍然是只支持单一数据源的DataSourceTransactionManager，这样会造成当某个操作失败抛出异常时将不会触发事务回滚。当时我提的建议是先评估一下功能场景，是否真的有必要将对两个不同数据源的操作放到同一事务中，如果一定要放在同一事务，至少要使用支持JTA的事务管理器。

我们需要简单了解下JTA事务和常见的JDBC事务的区别。JTA并不是这篇作业的主角，但了解JTA的机制将有助于理解后面的内容。我们知道事务的执行需要依赖资源管理器，在JDBC事务中就是DBMS，应用程序直接通过DataSource接口获取Connection，并通过Connection与资源管理器通信。而JTA事务则需要XA协议的支持，XA协议本质上是一种基于2PC的分布式事务协议，由支持分布式事务的事务管理器统一协调与各个支持XA协议的资源管理器的通信。我们在WebLogic上创建数据源时，会看到一页要求选择“是否支持全局事务”，如果选择支持，将创建XADataSource而非DataSource，对应的连接接口也变为XAConnection。而对于开发人员来说，JTA事务在实现上与普通JDBC事务并没有太大区别，需要关注的是事务管理器的具体实现，有一些开源的实现如Atomikos等，这里就不再单独举例了。

在各种微服务、分布式架构“大行其道”的现在，很多人会认为用了一些分布式软件、或做了数据拆分就是“分布式”了，而实际上真正的分布式系统在于各个分散资源的职责分配及功能协调，职责分配了，但是功能上没有协调和整合，和集群没啥分别。分布式事务的处理就是一种分布式环境下的功能协调，当一个场景下包含了分属不同资源管理器（不一定是DBMS）的操作，如何确保这些操作能协调一致的完成任务并不产生错乱，是非常重要的。

## 刚性事务与柔性事务

支付宝早在2008年就提出过柔性事务的概念，柔性事务是相对于刚性事务而言的，本地JDBC事务就是一种刚性事务。刚性事务要求严格遵守ACID，而分布式架构的应用，ACID特性是无法得到保障的，或者说保障的成本太高，因此需要换一种解决思路，就是柔性事务。柔性事务的理论基础是BASE理论，与ACID相对应，其中BA指的是Basic Availability，基本可用性，允许分区失败；S指的是Soft state，柔性状态，可以存在异步；E指得是Eventual consistency，最终一致性，不要求数据的实时一致。也就是说，BASE理论在确保可用性、性能的前提下，不要求强一致性。

## 柔性事务的几种处理思路

![柔性事务](https://github.com/gulfer/gulfer.github.io/blob/master/pic/soft-transaction.jpg)

柔性事务最开始是应对分布式的业务模块划分及数据划分，以及互联网应用面临的高并发场景设计的，所以说柔性事务也是分布式事务的另外一种形式。上图摘自支付宝的PPT，介绍了四种柔性事务的处理思路。需要说明的是，这些思路是一些解决分布式一致性的方法，每种思路适用于一些特定场景，所以这已经脱离了传统“事务”的概念，开发人员不再能像使用本地事务一样使用这些方法。而且是不是只有这几种处理方法，也未必一定。

* 2PC型

就是两阶段提交型。现在动辄提2PC，但实际上对应到不同的业务场景，每个阶段所执行操作的意义不同，不应混淆概念。比如执行某项业务需要先执行某些操作，用户确认后再执行其他操作，这种就不应该叫“两阶段提交”，因为既不是分布式的环境，也不是为了保证一致性。2PC分为准备和提交两个阶段，准备阶段和提交阶段，准备阶段期间各个分布式节点（资源管理器）检查是否可以执行某项操作，将事务操作信息记录在本地事务日志，并返回给发起节点或协调节点执行信息，事实上此时已经执行完成本地操作，资源已被占用，但并未提交而已，如果发生回滚，则根据本地事务日志执行回滚；到提交阶段，发起节点向各节点发出提交指令，才正式完成事务，并释放本地资源。

上文提到的JTA事务就属于2PC型，特点是整个事务过程是同步阻塞的，由于阻塞，当事务管理器发生故障时，所有参与事务处理的节点都会锁定，无法继续操作。为了解决同步阻塞的问题，一些分布式应用引入了3PC，将准备阶段再分为两步，不过这不是本文要讨论的要点，不做赘述。

我们知道2PC是同步阻塞的，也就知道2PC最大的问题就是执行效率比较低。但这仍然是一种分布式事务的解决思路，而实现上也相对简单。

* 补偿型

这里的补偿型方案主要是指TCC（Try-Confirm-Cancel）。其实TCC也是2PC的一种延伸，主要区别在于TCC不依赖于底层的事务管理器、资源管理器，而是完全由应用实现，灵活性比较好，想如何操作资源，是否锁定都可以自行决定。

支付宝的介绍材料给出了对TCC解释：**Try**阶段是尝试执行业务，需完成所有业务检查（一致性检查）并预留必须的业务资源（资源隔离）；**Confirm**阶段是确认执行业务，是真正执行业务的部分，不再进行业务检查，只能使用Try阶段预留的资源执行业务，并且要满足幂等性；**Cancel**阶段是执行事务回滚时的操作，要释放资源并满足幂等性。

方案示意图如下：

![TCC](https://github.com/gulfer/gulfer.github.io/blob/master/pic/tcc.png)

TCC事务是由主业务服务A发起的，各个从业务服务负责执行各自的本地事务，如一个转账操作，可能从服务B执行转账交易，从服务C执行限额处理。TCC的Try和Confirm可以对应2PC的两个阶段，而重点在于作为补偿的Cancel操作，在主业务服务A中的操作是可以先提交的，不再等待B和C执行完成，如果B发生回滚，则回调A和C的Cancel操作进行补偿。在阿里系的系统中有应用案例，不过对开发人员技术和业务理解能力要求比较高。实际上，个人认为在微服务架构中，TCC事务或者说补偿型的柔性事务，是一种比较合适的方案：在保证最终一致性的前提下，允许试错，提升整体事务执行效率，而开发及回滚的成本问题是需要评估的，看是否可以接受。

github上可以看到一些TCC的实现框架，我们将在下节具体分析。

* 异步确保型

异步确保型的思路主要是同步转异步，而实现这个方案最主要的工具是消息队列，而且是支持事务消息的消息队列。我们看一下下面的图示：

![事务消息](https://github.com/gulfer/gulfer.github.io/blob/master/pic/msg.png)

这个方案的实现过程是：当某个主业务流程在执行事务操作时，先向消息队列发送一个消息，用来获取事务ID，再执行主业务流程的本地事务，执行完成后使用事务ID向消息队列发送确认消息发送成功的消息，消息队列会根据确认消息向其他业务服务发送消息，执行各自的事务。如果确认消息发送失败，消息队列需要提供定期扫描的机制，检测主业务流程中的事务是否执行完成，也就是上图中的Bob的账户是否执行了扣款。

此方案的本质是由消息队列负责一致性和异步操作，并且消息队列的消息处理需要是幂等的，同一消息发送多次只执行一次。这样的思路好处显而易见，既对不同业务处理单元进行了解耦，利用了异步处理的高效性，又保证了一致性。有一定技术实力的公司，如支付宝、eBay都采用了此方案，我个人认为如果消息队列靠谱，此方案应优先考虑，ActiveMQ和RocketMQ都通过各自的方式支持了事务性质的消息，不过我没有使用过，没有发言权。如果没有特别完善支持事务消息的消息队列，使用消息队列自身的持久化机制，也是可以实现的，不过难度就比较大了。

* 最大努力通知型

这种方案的特点是，主业务服务只负责通知，不负责确认各个分布式业务服务是否真的执行完成事务。而通知一般会发送多次，因此也要保证幂等性，同时提供回调，供被通知方定时查询主业务服务执行状态。

这个方案明显对一致性要求没有那么高，或者说在短时间内要求并不高，并且实现起来成本也比较低，但是对场景的限定要求就比较高了。比较常见的场景就是通知，比如之前实现过的商户通知、定时对账等。

## 分布式事务框架

简单聊一聊分布式事务框架。分布式服务框架有Dubbo，分布式缓存有Redis，分布式数据库也有很多，但你是否听说过什么分布式事务框架，这种东西似乎并不存在于我们现有的技术栈里。也许你会说其实很多框架是支持了分布式事务的，比如Spring有对JTA的支持，但JTA由于其先天的性能劣势，现在已经不建议使用了。我们再回看上节提到的几种分布式事务处理思路，其实并没有一种思路是可以完全依赖某个开发框架实现的，都是针对特定的场景利用一些工具实现，开发框架很难覆盖完整的事务功能，这也是分布式事务和本地事务的一个区别。

对于补偿型的TCC事务是有一些框架的，这些框架不依赖于某种特定的通讯方式，可以采用HTTP，也可以采用RPC来实现分布式节点间通信。而对于支持TCC的服务，都提供try、confirm、cancel三种操作，框架实现类似TransactionManager的功能，用来在事务执行过程中回调上述三种TCC操作。git上排名较高的TCC框架包括ByteTCC、tcc-transaction等。

## 小结

从SOA架构到微服务，分布式事务一直是个很重要的话题，也是常被忽略的话题。很多人默认会采用同步阻塞的方式，因为实现成本小，但考虑到真实业务场景和流量场景，成本和方案都需要适当进行调整和平衡。本文结合支付宝相关材料讨论了分布式事务的几种实现思路，并简单介绍了TCC事务框架的实现原理。

参考资料：

[大规模SOA系统中的分布式事务处理](https://wenku.baidu.com/view/be946bec0975f46527d3e104.html)，阿里分布式事务处理方案介绍

[支付宝柔性事务介绍](https://wenku.baidu.com/view/d1bbd25877232f60ddcca1d9.html)，阿里对柔性事务介绍的材料，对几种思路的介绍更加清晰

[RocketMQ事务消息机制](http://www.jianshu.com/p/453c6e7ff81c)，可以查看第三节事务消息部分