# 分布式事务

最近在做代码评审的时候遇到这么一个问题：在某个声明式事务中使用了两个不同的数据源，而配置的事务管理器仍然是只支持单一数据源的DataSourceTransactionManager，这样会造成当某个操作失败抛出异常时将不会触发事务回滚。当时我提的建议是先评估一下功能场景，是否真的有必要将对两个不同数据源的操作放到同一事务中，如果一定要放在同一事务，至少要使用支持JTA的事务管理器。

我们需要简单了解下JTA事务和常见的JDBC事务的区别。JTA并不是这篇作业的主角，但了解JTA的机制将有助于理解后面的内容。我们知道事务的执行需要依赖资源管理器，在JDBC事务中就是DBMS，应用程序直接通过DataSource接口获取Connection，并通过Connection与资源管理器通信。而JTA事务则需要XA协议的支持，XA协议本质上是一种基于2PC的分布式事务协议，由支持分布式事务的事务管理器统一协调与各个支持XA协议的资源管理器的通信。我们在WebLogic上创建数据源时，会看到一页要求选择“是否支持全局事务”，如果选择支持，将创建XADataSource而非DataSource，对应的连接接口也变为XAConnection。而对于开发人员来说，JTA事务在实现上与普通JDBC事务并没有太大区别，需要关注的是事务管理器的具体实现，有一些开源的实现如Atomikos等，这里就不再单独举例了。

在各种微服务、分布式架构“大行其道”的现在，很多人会认为用了一些分布式软件、或做了数据拆分就是“分布式”了，而实际上真正的分布式系统在于各个分散资源的职责分配及功能协调，职责分配了，但是功能上没有协调和整合，和集群没啥分别。分布式事务的处理就是一种分布式环境下的功能协调，当一个场景下包含了分属不同资源管理器（不一定是DBMS）的操作，如何确保这些操作能协调一致的完成任务并不产生错乱，是非常重要的。

## 刚性事务与柔性事务

支付宝早在2008年就提出过柔性事务的概念，柔性事务是相对于刚性事务而言的，本地JDBC事务就是一种刚性事务。刚性事务要求严格遵守ACID，而分布式架构的应用，ACID特性是无法得到保障的，或者说保障的成本太高，因此需要换一种解决思路，就是柔性事务。柔性事务的理论基础是BASE理论，与ACID相对应，其中BA指的是Basic Availability，基本可用性，允许分区失败；S指的是Soft state，柔性状态，可以存在异步；E指得是Eventual consistency，最终一致性，不要求数据的实时一致。也就是说，BASE理论在确保可用性、性能的前提下，不要求强一致性。

## 柔性事务的几种处理思路

![柔性事务](https://github.com/gulfer/gulfer.github.io/blob/master/pic/soft-transaction.jpg)

2PC
补偿型
异步确保型
最大努力通知型

## 分布式事务框架

需

## 小结

其

参考书目：



